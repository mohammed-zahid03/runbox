// server/middleware/clerkAuth.js

const { Clerk } = require('@clerk/clerk-sdk-node');

const clerkClient = new Clerk({ apiKey: process.env.CLERK_API_KEY });

async function clerkAuth(req, res, next) {
  try {
    const authHeader = req.headers.authorization || '';
    const token = authHeader.replace(/^Bearer\s+/i, '').trim();

    if (!token) {
      return res.status(401).json({ error: 'Missing authorization token' });
    }

    const session = await clerkClient.sessions.verifySessionToken(token).catch(() => null);

    if (!session || !session.user_id) {
      return res.status(401).json({ error: 'Invalid or expired token' });
    }

    req.userId = session.user_id; 
    req.clerkSession = session;

    return next();
  } catch (err) {
    console.error('Clerk auth error:', err);
    return res.status(401).json({ error: 'Unauthorized' });
  }
}

module.exports = clerkAuth;
